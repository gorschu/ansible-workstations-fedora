---
# Configure resticprofile - directories, config files, hooks

- name: Create directories
  ansible.builtin.file:
    path: "{{ item.path }}"
    state: directory
    mode: "{{ item.mode }}"
    owner: root
    group: root
  loop:
    - {path: /etc/resticprofile, mode: "0700"}
    - {path: /etc/resticprofile/hooks, mode: "0700"}
    - {path: /var/lib/resticprofile, mode: "0755"}

- name: Set resticprofile credentials from vault
  ansible.builtin.set_fact:
    resticprofile_backend_credentials: "{{ vault_resticprofile_backends }}"
    resticprofile_backend_names: "{{ vault_resticprofile_backends.keys() | list }}"
    resticprofile_pushover_token: "{{ vault_resticprofile_pushover.token }}"
    resticprofile_pushover_user_key: "{{ vault_resticprofile_pushover.user_key }}"
  no_log: true

- name: Deploy profiles.toml
  block:
    - name: Create temp file for config comparison
      ansible.builtin.tempfile:
        state: file
        suffix: .toml
      register: resticprofile_temp_config
      changed_when: false

    - name: Dry-run template profiles.toml to temp location
      ansible.builtin.template:
        src: profiles.toml.j2
        dest: "{{ resticprofile_temp_config.path }}"
        mode: "0600"
      changed_when: false

    - name: Check config checksums
      ansible.builtin.stat:
        path: "{{ item }}"
        checksum_algorithm: sha256
      register: resticprofile_config_stats
      loop:
        - /etc/resticprofile/profiles.toml
        - "{{ resticprofile_temp_config.path }}"

    - name: Determine if config needs update
      vars:
        current: "{{ resticprofile_config_stats.results[0].stat }}"
        new: "{{ resticprofile_config_stats.results[1].stat }}"
      ansible.builtin.set_fact:
        resticprofile_config_needs_update: >-
          {{ not current.exists or current.checksum != new.checksum }}

    - name: Update resticprofile config if changed
      when: resticprofile_config_needs_update | bool
      block:
        - name: Unschedule all timers before updating config
          ansible.builtin.command:
            cmd: "{{ resticprofile_bin_path }}/resticprofile unschedule --all"
          failed_when: false
          changed_when: true

        - name: Deploy profiles.toml
          ansible.builtin.template:
            src: profiles.toml.j2
            dest: /etc/resticprofile/profiles.toml
            mode: "0600"
            owner: root
            group: root
          notify: Systemd daemon-reload

        - name: Flush handlers before running resticprofile schedule
          ansible.builtin.meta: flush_handlers

        - name: Regenerate systemd units
          ansible.builtin.command:
            cmd: "{{ resticprofile_bin_path }}/resticprofile schedule --all --start --reload"
          changed_when: true

  always:
    - name: Cleanup temp config file
      ansible.builtin.file:
        path: "{{ resticprofile_temp_config.path }}"
        state: absent
      changed_when: false

- name: Deploy hook scripts
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    mode: "0755"
    owner: root
    group: root
  loop:
    - {src: notify.sh.j2, dest: /etc/resticprofile/hooks/notify.sh}
    - {src: check-metered.sh.j2, dest: /etc/resticprofile/hooks/check-metered.sh}

- name: Deploy excludes.txt
  ansible.builtin.copy:
    src: excludes.txt
    dest: /etc/resticprofile/excludes.txt
    mode: "0600"
    owner: root
    group: root

- name: Deploy systemd drop-in file
  ansible.builtin.template:
    src: 99-skip-metered.conf.j2
    dest: /etc/resticprofile/99-skip-metered.conf
    mode: "0644"
    owner: root
    group: root
  notify: Systemd daemon-reload

- name: Deploy backend-specific env files
  ansible.builtin.template:
    src: backend.env.j2
    dest: "/etc/resticprofile/{{ item }}.env"
    mode: "0600"
    owner: root
    group: root
  vars:
    backend: "{{ item }}"
  loop: "{{ resticprofile_backend_names }}"
  no_log: true

- name: Ensure status.json has appropriate permissions
  ansible.builtin.file:
    path: /var/lib/resticprofile/status.json
    mode: "0644"
    owner: root
    group: root
  failed_when: false
